<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial;
            text-align: center;
            background: #222;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 5px;
        }

        h2 {
            margin: 5px 0;
            font-size: 1.5rem;
        }

        canvas {
            background: black;
            display: block;
            width: 90vw;
            max-width: 400px;
            height: auto;
            aspect-ratio: 1/1;
            margin: 0 auto;
            border: 2px solid #fff;
            border-radius: 8px;
        }

        #score,
        #highscore {
            font-size: 1.2rem;
            margin: 5px 0;
        }

        #restart {
            display: none;
            background: #f39c12;
            color: #fff;
            padding: 10px 20px;
            font-size: 1.2rem;
            border: none;
            border-radius: 6px;
            margin: 10px 0;
            cursor: pointer;
        }

        /* Compact D-pad Controls */
        .controls {
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .row {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .middle-row {
            justify-content: center;
            align-items: center;
        }

        .spacer {
            width: 50px;
        }

        .control-btn {
            background: #3498db;
            color: #fff;
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media(max-width:360px) {
            h2 {
                font-size: 1.3rem;
            }

            canvas {
                width: 95vw;
                max-width: 350px;
            }

            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 1.5rem;
            }

            .spacer {
                width: 45px;
            }

            #restart {
                font-size: 1rem;
                padding: 8px 16px;
            }
        }
    </style>
</head>

<body>

    <h2>Snake Game</h2>
    <canvas id="game" width="400" height="400"></canvas>
    <p id="score">Score: 0</p>
    <p id="highscore">High Score: 0</p>
    <button id="restart">Restart Game</button>

    <!-- D-pad Controls -->
    <div class="controls">
        <div class="row">
            <button class="control-btn" id="up">⬆️</button>
        </div>
        <div class="row middle-row">
            <button class="control-btn" id="left">⬅️</button>
            <div class="spacer"></div>
            <button class="control-btn" id="right">➡️</button>
        </div>
        <div class="row">
            <button class="control-btn" id="down">⬇️</button>
        </div>
    </div>

    <!-- Audio -->
    <audio id="eatSound" src="eat.mp3" preload="auto"></audio>
    <audio id="gameOverSound" src="gameover.mp3" preload="auto"></audio>

    <script>
        // Service Worker
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("sw.js");
        }

        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const SIZE = 20;
        let snake, food, dx, dy, score, gameLoop, speed;
        let highscore = localStorage.getItem("snakeHighScore") || 0;
        const eatSound = document.getElementById("eatSound");
        const gameOverSound = document.getElementById("gameOverSound");
        document.getElementById("highscore").textContent = "High Score: " + highscore;

        function initGame() {
            snake = [{ x: 5, y: 5 }];
            food = { x: 10, y: 10 };
            dx = 1; dy = 0;
            score = 0;
            speed = 350; // reset initial speed
            document.getElementById("score").textContent = "Score: 0";
            document.getElementById("restart").style.display = "none";
            clearInterval(gameLoop);
            gameLoop = setInterval(draw, speed);
        }

        function gameOver() {
            clearInterval(gameLoop);
            gameOverSound.currentTime = 0;
            gameOverSound.play();

            if (score > highscore) {
                highscore = score;
                localStorage.setItem("snakeHighScore", highscore);
            }
            document.getElementById("highscore").textContent = "High Score: " + highscore;

            // show restart button after game over sound ends
            gameOverSound.onended = () => {
                document.getElementById("restart").style.display = "inline-block";
            };
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw food as circle
            ctx.fillStyle = "red";
            ctx.beginPath();
            ctx.arc(food.x * SIZE + SIZE / 2, food.y * SIZE + SIZE / 2, SIZE / 2, 0, Math.PI * 2);
            ctx.fill();

            // Draw snake body
            for (let i = 1; i < snake.length; i++) {
                const part = snake[i];
                ctx.fillStyle = "lime";
                ctx.beginPath();
                ctx.ellipse(part.x * SIZE + SIZE / 2, part.y * SIZE + SIZE / 2, SIZE / 2, SIZE / 2, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // Tail as smaller ellipse
            if (snake.length > 1) {
                const tail = snake[snake.length - 1];
                ctx.fillStyle = "lime";
                ctx.beginPath();
                ctx.ellipse(tail.x * SIZE + SIZE / 2, tail.y * SIZE + SIZE / 2, SIZE / 2 * 0.7, SIZE / 2 * 0.7, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            // Head as ellipse
            const head = snake[0];
            ctx.fillStyle = "lime";
            ctx.beginPath();
            ctx.ellipse(head.x * SIZE + SIZE / 2, head.y * SIZE + SIZE / 2, SIZE / 2, SIZE * 0.4, 0, 0, Math.PI * 2);
            ctx.fill();

            // Move snake
            let newHead = { x: head.x + dx, y: head.y + dy };

            // Collision
            if (newHead.x < 0 || newHead.y < 0 || newHead.x >= canvas.width / SIZE || newHead.y >= canvas.height / SIZE
                || snake.some(s => s.x === newHead.x && s.y === newHead.y)) {
                gameOver();
                return;
            }

            snake.unshift(newHead);

            // Eat food
            if (newHead.x === food.x && newHead.y === food.y) {
                score++;
                document.getElementById("score").textContent = "Score: " + score;

                // Play eat sound
                eatSound.currentTime = 0;
                eatSound.play();

                // Variable speed
                speed = Math.max(150, speed - 1); // decrease by 2ms but not below 100ms
                clearInterval(gameLoop);
                gameLoop = setInterval(draw, speed);

                // New food
                food.x = Math.floor(Math.random() * (canvas.width / SIZE));
                food.y = Math.floor(Math.random() * (canvas.height / SIZE));
            } else {
                snake.pop();
            }
        }

        function changeDir(dir) {
            if (dir === "up" && dy === 0) { dx = 0; dy = -1; }
            else if (dir === "down" && dy === 0) { dx = 0; dy = 1; }
            else if (dir === "left" && dx === 0) { dx = -1; dy = 0; }
            else if (dir === "right" && dx === 0) { dx = 1; dy = 0; }
        }

        // Keyboard controls
        document.addEventListener("keydown", e => {
            if (e.key === "w") changeDir("up");
            if (e.key === "s") changeDir("down");
            if (e.key === "a") changeDir("left");
            if (e.key === "d") changeDir("right");
        });

        // Button controls
        ["up", "down", "left", "right"].forEach(dir => {
            document.getElementById(dir).addEventListener("click", () => {
                changeDir(dir);
                draw(); // instant move
            });
        });

        document.getElementById("restart").addEventListener("click", initGame);

        // Preload audio
        eatSound.load();
        gameOverSound.load();

        initGame();
    </script>
</body>

</html>